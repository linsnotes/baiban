<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Pinyin Converter</title>
    <script data-goatcounter="https://linsnotes.goatcounter.com/count" async src="https://gc.zgo.at/count.js"></script>
    <style>
      html {
        font-size: 16px;
      }
      :root {
        --hanzi-size: 1.5rem;
        --pinyin-size: 0.875rem;
        --pinyin-color: #666;
        --hanzi-color: #000;
        --hanzi-font: 
          "STKaiti",
          "Kaiti SC",
          "Kaiti TC",
          "KaiTi",
          "楷体",
          "华文楷体",
          "Apple Kaiti",
          serif;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .hidden {
        display: none !important;
      }
      .container {
        flex: 1;
        display: flex;
        gap: 1.25rem;
        padding: 1.25rem;
      }
      .input-section,
      .output-section {
        flex: 1;
        padding: 1.25rem;
        border: 1px solid #ccc;
        border-radius: 0.5rem;
      }
      .output-section {
        white-space: pre-wrap;
      }
      .input-section {
        padding-bottom: 1.5rem; /* Add extra space at the bottom */
      }
      #visitor-counter {
        font-size: 1em;
        text-align: center;
        color: #333;
      }

      #visitor-counter #pageviews {
        font-weight: bold;
        color: #000;
      }

      .input-section.fullscreen-hidden {
        display: none;
      }
      .output-section.fullscreen {
        position: static;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        padding: 3.75rem;
        border: none;
        border-radius: 0;
      }
      textarea {
        width: 100%;
        height: 96%;
        padding: 0.625rem;
        border: none;
        margin-bottom: 0.625rem;
        resize: vertical;
      }
      textarea:focus {
        outline: none;
      }
      textarea::placeholder {
        color: #164587;
        font-size: 1.3rem;
        opacity: 1;
      }
      .hanzi-pinyin {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        margin: 0.125rem;
        line-height: 1.2;
      }
      .pinyin {
        font-size: var(--pinyin-size);
        color: var(--pinyin-color);
      }
      .hanzi {
        font-size: var(--hanzi-size);
        color: var(--hanzi-color);
        font-family: var(--hanzi-font) !important;
      }
      .button-container {
        position: fixed;
        bottom: 0.05rem;
        left: 0;
        width: 100%;
        display: flex; 
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 1.25rem;
        flex-wrap: nowrap;
        z-index: 1001;
        background: transparent;
        padding: 0.9375rem 1.25rem;
        box-shadow: none;
      }
      .button-container button,
      .button-container label {
        align-items: center;
        justify-content: center;
        background-color: #007aff;
        color: #ffffff;
        border: none;
        padding: 0.5rem 0.5rem;
        border-radius: 0.375rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin: 0;
        height: 3.1875rem;
        width: auto;
        font-size: 0.8125rem;
        transition: background-color 0.3s, box-shadow 0.3s;
      }
      .button-container button:hover,
      .button-container label:hover {
        background-color: #005bb5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      .button-container label {
        cursor: default;
        display: flex;
        flex-direction: column;
      }
      .button-container input,
      .button-container select {
        margin-top: 0.3125rem;
      }
      .button-container select {
        background-color: #007aff;
        color: #ffffff;
        border: none;
        padding: 0.5rem 0.5rem;
        border-radius: 0.375rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin: 0;
        height: 3.1875rem;
        width: auto;
        font-size: 0.8125rem;
        transition: background-color 0.3s, box-shadow 0.3s;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      #excelDropdown, #voiceSelect {
          width: 10rem;
      }

      .button-container select:focus {
        outline: none;
      }
      .output-section.hide-pinyin .pinyin {
        display: none;
      }


      @media (max-width:1200px) {
        .button-container label:nth-of-type(1),
        .button-container label:nth-of-type(2),
        .button-container label:nth-of-type(3),
        .button-container label:nth-of-type(4) {
          display: none;
        }
        .print-btn {
          display: none;
        }
        .button-container button,
        .button-container label,
        .button-container select {
          height: 2.5rem;
        }

        #excelDropdown, #voiceSelect {
          width: 5rem;
        }

        #voiceSelect {
          width: 100px;
        }
        .container {
          flex-direction: column;
          height: auto;
        }
        .input-section,
        .output-section {
          width: 100%;
          height: auto;
        }
        textarea::placeholder {
          font-size: 0.9rem;
        }

        .output-section.fullscreen {
          padding: 1.5625rem;
        }
        .button-container {
          bottom: 0.8rem;
          flex-wrap: wrap;
          display: flex;
          flex-wrap: wrap;
          justify-content: center;  
          align-items: center; 
          gap: 0.5rem;
        }
      }
      @media print {
        .button-container {
          display: none !important;
        }
      }

    </style>
  </head>
  <body>
    <div class="container">
      <div class="input-section">
        <textarea placeholder="Move the cursor to the bottom of the page, OR tap the bottom on a touch device, to reveal the control menu.
        
You can enter Chinese text in 3 ways:
(1) manually type it into this box,
(2) copy and paste it, or
(3) upload an Excel file (.xlsx) where Column A contains titles and Column B contains text.
        
Due to differences in browser support for voice synthesis across devices, the read-aloud function is only available on PCs and iPhones. For the best experience, using this web app on a PC is recommended."></textarea>
        <div id="visitor-counter">
          Welcome! You’re visitor #<span id="pageviews">Loading...</span>
        </div>
      </div>
      <div class="output-section"></div>
    </div>

    <div class="button-container">
      <button id="toggleInput" type="button">Hide Editor</button>
      <button id="togglePinyin" type="button">Hide Pinyin</button>

      <label>Hanzi Size
        <input type="number" id="hanziSize" min="12" max="100" value="24">
      </label>

      <label>Pinyin Size
        <input type="number" id="pinyinSize" min="10" max="100" value="14">
      </label>
      <label>Pinyin Color
        <input type="color" id="pinyinColor" value="#666666">
      </label>
      <label>Hanzi Color
        <input type="color" id="hanziColor" value="#000000">
      </label>
      
      <!-- Excel Upload -->
      <button id="uploadExcel" type="button">Upload</button>
      <input type="file" id="excelFileInput" accept=".xlsx" style="display:none">
      <select id="excelDropdown" class="hidden">
        <option value="" disabled selected>Select</option>
      </select>

      <!-- Voice / Read-Aloud -->
      <select id="voiceSelect">
        <option value="" disabled selected>Select Voice</option>
      </select>
      <button id="readAloudBtn" type="button">Read Aloud</button>
      <button id="pauseResumeBtn" type="button" disabled>Pause</button>
      <button class="print-btn" onclick="window.print()">Print This</button>
    </div>

    <script src="https://unpkg.com/pinyin-pro"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      // -------------------------
      // Pinyin Processing Logic
      // -------------------------

      const inputSection = document.querySelector('.input-section');
      const outputSection = document.querySelector('.output-section');
      const textarea = document.querySelector('textarea');
      const toggleInput = document.querySelector('#toggleInput');
      const togglePinyin = document.querySelector('#togglePinyin');
      const hanziSize = document.querySelector('#hanziSize');
      const pinyinSize = document.querySelector('#pinyinSize');
      const pinyinColor = document.querySelector('#pinyinColor');
      const hanziColor = document.querySelector('#hanziColor');

      textarea.addEventListener('input', debounce(processText, 300));

      toggleInput.addEventListener('click', () => {
        inputSection.classList.toggle('fullscreen-hidden');
        outputSection.classList.toggle('fullscreen');
        toggleInput.textContent = inputSection.classList.contains('fullscreen-hidden')
          ? 'Show Editor'
          : 'Hide Editor';
      });

      togglePinyin.addEventListener('click', () => {
        outputSection.classList.toggle('hide-pinyin');
        togglePinyin.textContent = outputSection.classList.contains('hide-pinyin')
          ? 'Show Pinyin'
          : 'Hide Pinyin';
      });

      hanziSize.addEventListener('input', updateFontSizes);
      pinyinSize.addEventListener('input', updateFontSizes);
      pinyinColor.addEventListener('input', (e) => {
        document.documentElement.style.setProperty('--pinyin-color', e.target.value);
      });
      hanziColor.addEventListener('input', (e) => {
        document.documentElement.style.setProperty('--hanzi-color', e.target.value);
      });

      async function processText() {
        const rawText = textarea.value;
        try {
          const pinyinData = await getPinyinData(rawText);
          const tempDiv = document.createElement('div');
          tempDiv.textContent = rawText;
          processTextNodes(tempDiv, pinyinData);
          outputSection.innerHTML = '';
          outputSection.appendChild(tempDiv);
        } catch (error) {
          console.error('Error processing text:', error);
        }
      }

      async function getPinyinData(text) {
        const options = {
          type: 'array',
          toneType: 'symbol',
          pattern: 'pinyin',
          multiple: true,
          removeNonZh: false,
          nonZh: 'spaced',
          v: false,
          mode: 'normal'
        };
        try {
          const result = pinyinPro.pinyin(text, options);
          return result.map((pinyin, index) => ({
            hanzi: text[index],
            pinyin: pinyin
          }));
        } catch (error) {
          console.error('Error fetching Pinyin data:', error);
          return [];
        }
      }

      function processTextNodes(node, pinyinData) {
        const walker = document.createTreeWalker(
          node,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        let pinyinIndex = 0;
        let textNode;
        while ((textNode = walker.nextNode())) {
          const chars = textNode.nodeValue.split('');
          const parent = textNode.parentNode;
          const fragment = document.createDocumentFragment();
          chars.forEach((char) => {
            if (char === '\n') {
              const br = document.createElement('br');
              fragment.appendChild(br);
              if (pinyinIndex < pinyinData.length) pinyinIndex++;
            } else {
              const wrapper = document.createElement('span');
              wrapper.className = 'hanzi-pinyin';
              if (isHanzi(char) && pinyinIndex < pinyinData.length) {
                wrapper.innerHTML = `
                  <span class="pinyin">${pinyinData[pinyinIndex].pinyin}</span>
                  <span class="hanzi">${char}</span>
                `;
                pinyinIndex++;
              } else {
                wrapper.innerHTML = `
                  <span class="pinyin"></span>
                  <span class="hanzi">${char}</span>
                `;
                if (pinyinIndex < pinyinData.length) pinyinIndex++;
              }
              fragment.appendChild(wrapper);
            }
          });
          parent.replaceChild(fragment, textNode);
        }
      }

      function isHanzi(char) {
        return /[\u4e00-\u9fa5]/.test(char);
      }

      function updateFontSizes() {
        const baseFontSize = 16;
        document.documentElement.style.setProperty('--hanzi-size', `${(hanziSize.value / baseFontSize).toFixed(3)}rem`);
        document.documentElement.style.setProperty('--pinyin-size', `${(pinyinSize.value / baseFontSize).toFixed(3)}rem`);
      }

      function debounce(fn, delay) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      updateFontSizes();

      // -------------------------
      // Excel Upload
      // -------------------------
      const uploadExcelButton = document.querySelector('#uploadExcel');
      const excelFileInput = document.querySelector('#excelFileInput');
      const excelDropdown = document.querySelector('#excelDropdown');

      uploadExcelButton.addEventListener('click', () => {
        excelFileInput.click();
      });

      excelFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          const filteredData = jsonData.filter(row => row.length >= 2);
          excelDropdown.innerHTML = '<option value="" disabled selected>Select</option>';
          filteredData.forEach((row, index) => {
            const option = document.createElement('option');
            option.textContent = row[0];
            option.value = index;
            option.dataset.text = row[1];
            excelDropdown.appendChild(option);
          });
          if (filteredData.length > 0) {
            excelDropdown.classList.remove('hidden');
          } else {
            excelDropdown.classList.add('hidden');
          }
        };
        reader.readAsArrayBuffer(file);
      });

      excelDropdown.addEventListener('change', () => {
        const selectedOption = excelDropdown.options[excelDropdown.selectedIndex];
        if (!selectedOption.dataset.text) {
          return; 
        }
        textarea.value = selectedOption.dataset.text;
        processText();
      });

      // -------------------------
      // Speech Synthesis
      // -------------------------
      const voiceSelect = document.getElementById('voiceSelect');
      const readAloudBtn = document.getElementById('readAloudBtn');
      const pauseResumeBtn = document.getElementById('pauseResumeBtn');
      let utterance = null;

      function detectDeviceAndBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        let device = 'other'; 
        let browser = 'other';

        if (/android/i.test(userAgent)) {
          device = 'android';
        } else if (/ipad|iphone|ipod/.test(userAgent) && !window.MSStream) {
          device = 'ios';
        } else if (/windows nt/i.test(userAgent)) {
          device = 'windows';
        } else if (/macintosh/i.test(userAgent) && !/iphone|ipad/.test(userAgent)) {
          device = 'mac';
        } 

        if (userAgent.indexOf('firefox') > -1) {
          browser = 'firefox';
        } else if (userAgent.indexOf('opr') > -1 || userAgent.indexOf('opera') > -1) {
          browser = 'opera';
        } else if (userAgent.indexOf('trident') > -1) {
          browser = 'ie';
        } else if (userAgent.indexOf('edg') > -1) {
          browser = 'edge'; 
        } else if (userAgent.indexOf('chrome') > -1) {
          browser = 'chrome';
        } else if (userAgent.indexOf('safari') > -1) {
          browser = 'safari';
        }

        return { device, browser };
      }

      function populateVoiceList() {
        const voices = speechSynthesis.getVoices();
        voiceSelect.innerHTML = '<option value="" disabled selected>Select Chinese Voice</option>';
        const chineseVoices = voices.filter(v => v.lang.toLowerCase().includes('zh'));

        chineseVoices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = `${voice.name} (${voice.lang})`;
          voiceSelect.appendChild(option);
        });

        const { device, browser } = detectDeviceAndBrowser();
        let targetKeyword = '';

        if (device === 'windows' && browser === 'chrome') {
          targetKeyword = 'huihui';
        } else if (device === 'windows' && browser === 'edge') {
          targetKeyword = 'yunyang'; 
        } else if (device === 'ios') {
          targetKeyword = 'meijia';
        } else if (device === 'android' && browser === 'firefox') {
          targetKeyword = 'taiwan'; 
        }

        if (targetKeyword) {
          for (let i = 0; i < voiceSelect.options.length; i++) {
            const voiceName = voiceSelect.options[i].value.toLowerCase();
            if (voiceName.includes(targetKeyword)) {
              voiceSelect.selectedIndex = i;
              break;
            }
          }
        }
      }

      populateVoiceList();
      speechSynthesis.onvoiceschanged = populateVoiceList;

      function readAloud() {
        const text = textarea.value.trim();
        if (!text) {
          alert('Please enter some text first.');
          return;
        }
        if (speechSynthesis.speaking) {
          speechSynthesis.cancel();
        }
        utterance = new SpeechSynthesisUtterance(text);

        const selectedVoice = voiceSelect.value;
        if (!selectedVoice) {
          alert('Please select a Chinese voice first.');
          return;
        }
        const voiceObj = speechSynthesis.getVoices().find(v => v.name === selectedVoice);
        if (voiceObj) {
          utterance.voice = voiceObj;
        }

        utterance.rate = 1;
        utterance.pitch = 1;

        pauseResumeBtn.disabled = false;
        pauseResumeBtn.textContent = 'Pause';

        utterance.onend = () => {
          pauseResumeBtn.disabled = true;
          pauseResumeBtn.textContent = 'Pause';
        };

        speechSynthesis.speak(utterance);
      }

      readAloudBtn.addEventListener('click', readAloud);

      pauseResumeBtn.addEventListener('click', () => {
        if (speechSynthesis.speaking && !speechSynthesis.paused) {
          speechSynthesis.pause();
          pauseResumeBtn.textContent = 'Resume';
        } else if (speechSynthesis.paused) {
          speechSynthesis.resume();
          pauseResumeBtn.textContent = 'Pause';
        }
      });

      // -------------------------
      // Auto-Show/Hide of Button Container
      // -------------------------
      const buttonContainer = document.querySelector('.button-container');
      buttonContainer.classList.add('hidden');

      const SHOW_ZONE = 120;
      document.addEventListener('mousemove', (e) => {
        if (window.innerHeight - e.clientY < SHOW_ZONE) {
          buttonContainer.classList.remove('hidden');
        } else {
          buttonContainer.classList.add('hidden');
        }
      });
      document.addEventListener('touchstart', (e) => {
        if (e.touches.length > 0) {
          const touchY = e.touches[0].clientY;
          if (window.innerHeight - touchY < SHOW_ZONE) {
            buttonContainer.classList.remove('hidden');
          } else {
            buttonContainer.classList.add('hidden');
          }
        }
      });

      // ------------------------------------------------------------------
      //  >>> Hide Read-Aloud UI on non-iPhone mobile <<<
      // ------------------------------------------------------------------
      {
        const { device } = detectDeviceAndBrowser();
        // Check if it's opened on a mobile device:
        const isMobile = /Mobi|Android|iPad|iPhone|iPod/i.test(navigator.userAgent);

        // If mobile but NOT iPhone:
        if (isMobile && device !== 'ios') {
          // Hide the read-aloud elements
          readAloudBtn.style.display = 'none';
          voiceSelect.style.display = 'none';
          pauseResumeBtn.style.display = 'none';

          // Alert user
          alert('The read aloud only works in PC (or iPhone).');
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
            const pv = document.getElementById('pageviews');

            if (pv !== null) {
                  // Strip trailing slash (if any) so the path matches GoatCounter
                  const uri = location.pathname.replace(/\/$/, '');
                  // Build the JSON endpoint URL for your domain
                  const url = `https://linsnotes.goatcounter.com/counter/${encodeURIComponent(uri)}.json`;

                  fetch(url)
                        .then((response) => response.json())
                        .then((data) => {
                              // 'data.count' comes back as a string with possible whitespace
                              const count = data.count.replace(/\s/g, '');
                              // Format it with commas, etc.
                              pv.innerText = new Intl.NumberFormat().format(count);
                        })
                        .catch((error) => {
                              // Fallback if something goes wrong
                              pv.innerText = '1';
                        });
            }
      });
    </script>
  </body>
</html>
